function LoadPrinters(n){var t=$("select",n.delegateTarget);$.get(n.data.url).then(function(n,t,i){$.each(n,function(n,t){var i=$("<option><\/option>").val(t.Name).text(t.Name+" : "+t.Description);t.Name===this.selected&&i.attr("selected","selected");this.ddl.append(i)}.bind({ddl:this.ddl,selected:i.getResponseHeader("Selected")}))}.bind({ddl:t}),function(n,t){var i=$("<option><\/option>").val("").html('<span class="bg-danger">Could not retrieve printer list: '+t+" "+n.status+"<\/span>");this.append(i)}.bind(this))}function OnPrint(n){function t(n,t){$("div.alert",this).removeClass().addClass("alert").addClass(t).html(n)}var i=$(n.delegateTarget),r=$("select",i).val();if(!r){t.call(i,"Please Select a printer","alert-warning");return}n.data.postdata[0].value=$("span.cartonId",i).text();n.data.postdata[1].value=r;$.post(n.data.url,n.data.postdata).then(function(n,i,r){t.call(this.dlg,r.responseText,r.status===203?"alert-warning":"alert-success")}.bind({dlg:n.delegateTarget}),function(n){Sound.error();t.call(this.dlg,n.responseText,"alert-danger")}.bind({dlg:n.delegateTarget}))}function OnRemove(n){var t=$(n.delegateTarget);n.data.postdata[0].value=$("span.cartonId",t).text();$.post(n.data.url,n.data.postdata).then(function(n){t.modal("hide");Tabs.html(n);Progress.update(-1)}.bind({dlg:n.delegateTarget}),function(n){Sound.error();alert("Error: "+n.responseText)}.bind({dlg:n.delegateTarget}))}var Sound=function(){"use strict";var n={error:null,success:null},t=function(t){n=$.extend(n,t)},i=function(){$(n.error).one("ended",function(){this.play()})[0].play()},r=function(){$(n.success)[0].play()};return{init:t,error:i,success:r}}(),Progress=function(){"use strict";var n={bar:"#progressCartons",receivedCount:"#receivedCount"},t=function(t){n=$.extend(n,t)},i=function(t){var i=$(n.bar+"div.progress-bar"),r=parseInt(i.attr("aria-valuenow"))+t,e=parseInt(i.attr("aria-valuemax")),u=Math.round(r*100/e),f;i.attr("aria-valuenow",r).css("width",u+"%").find("span").text(u);f=parseInt($(n.receivedCount).text());$(n.receivedCount).text(f+t)};return{init:t,update:i}}(),Tabs=function(){"use strict";var n={tabContainer:"",contentContainer:"",loadUrl:"",pallets:[]},t="data-palletid",u=function(t){n=$.extend(n,t);var i;$.each(n.pallets,function(n,t){var r=Tabs.create(t);n===0&&(i=r)});$(n.tabContainer).on("click",".glyphicon-remove-sign",function(n){var t=$(this).closest("li"),i,r;t.is(".active")&&(i=t.next(),i.length===0&&(i=$("li:first",n.delegateTarget)),$("a",i).tab("show"));r=$("a",t).attr("href");$(r).remove();t.remove()}).on("shown.bs.tab",function(){r()}).find("li:first a").tab("show")},i=function(){return $("> div.active.tab-pane",n.contentContainer)},f=function(){return $("> li.active",n.tabContainer).attr(t)},e=function(i){var u="Pallet_"+(i||"NOPALLET"),r;return $("<div><\/div>").attr("id",u).addClass("tab-pane").appendTo(n.contentContainer),r=$("<a><\/a>").attr({href:"#"+u,role:"tab","data-toggle":"tab",title:"Pallet "+(i||"??")}).text(i||"NOPALLET"),i&&r.append(' <span title="Remove Pallet" class="glyphicon glyphicon-remove-sign text-info"><\/span>'),$("<li><\/li>").attr(t,i).append(r).appendTo(n.tabContainer)},o=function(i){var r=$("> li["+t+'="'+i+'"] > a',n.tabContainer).tab("show");r.length>0||Tabs.create(i).find("a").tab("show")},s=function(n){i().html(n)},r=function(){return Tabs.html("Loading..."),$.get(n.loadUrl.replace("~",Tabs.activePalletId())).then(function(n){Tabs.html(n)},function(n){Tabs.html(n.responseText)})};return{init:u,create:e,activePalletId:f,html:s,show:o,activeContent:i,load:r}}(),HandleScan=function(){"use strict";var i,r,t,n={textarea:"",button:"",cartonUrl:"",cartonPostdata:function(){},delay:3e3},u=function(){return i?(clearInterval(i),i=null,$("span.badge",n.button).addClass("hidden"),!0):!1},c=function(){u();r=n.delay;$("span.badge",n.button).removeClass("hidden").text("");i=setInterval(function(){r-=1e3;$("span.badge",n.button).text(r/1e3);r<=0&&p()},1e3)},l=function(){u();$(n.button).prop("disabled",!0).find("img").removeClass("hidden");$(n.textarea).prop("disabled",!0);v()},a=function(){$(n.button).prop("disabled",!1).find("img").addClass("hidden");t.prop("disabled",!1)},f=function(i){Sound.error();t.attr("data-content",i).popover("show");$(n.button).next("button").removeClass("hidden")},v=function(){$(n.button).next("button").addClass("hidden");$(n.textarea).popover("hide")},e=function(){var n=o();return n.length===0?!1:s(n[n.length-1])?!0:Tabs.activePalletId()?!0:(f("Please scan a pallet first"),!1)},y=function(i){n=$.extend(n,i);t=$(n.textarea);t.on("keypress",function(n){(u(),n.which===13)&&(Sound.success(),e()&&c())}).popover({trigger:"manual",html:!0,title:'<strong class="text-danger"><span class="text-danger glyphicon glyphicon-warning-sign"><\/span> Error Message<\/strong><a class="close text-danger" href="#">&times;<\/a>',placement:"auto",container:"body"}).on("shown.bs.popover",function(){t.select().focus()});$(document).on("click",".close",function(){t.popover("hide").focus()});$(n.button).on("click",function(){e()&&act()}).next("button").on("click",function(){t.popover("show")})},o=function(){return $.grep($(n.textarea).val().toUpperCase().split("\n"),function(n){return n.trim().toUpperCase()!==""})},s=function(n){return n.toUpperCase().indexOf("P")===0},p=function(){var n;if(u(),n=o(),n.length!==0){var r=$.Deferred(l),i=r,f=n[n.length-1];s(f)?(n.length>1&&(i=i.then(h.bind(undefined,n.slice(0,n.length-1)))),i=i.then(w.bind(undefined,f))):i=i.then(h.bind(undefined,n));i=i.always(a).always(function(){t.focus()});r.resolve()}},h=function(i){return $.post(n.cartonUrl,n.cartonPostdata(Tabs.activePalletId(),i)).then(function(n){if(n&&n.length>0){var i=$('<ul class="list-group"><\/ul>'),r=[];$.each(n,function(n,t){$('<li class="list-group-item list-group-item-warning"><\/li>').text(t.cartonId+": "+t.message).appendTo(i);r.push(t.cartonId)});f(i[0].outerHTML);t.val(r.join("\n"))}else t.val("");Tabs.load();Progress.update(this.count)}.bind({count:i.length}),function(n,t,i){switch(n.status){case 500:f(n.responseText);break;default:f("Error "+n.status+": "+i)}})},w=function(n){Tabs.show(n)};return{init:y}}();