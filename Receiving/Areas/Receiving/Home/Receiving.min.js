function LoadPrinters(n){var t=$("select",n.delegateTarget);$.get(n.data.url).then(function(n,t,i){$.each(n,function(n,t){var i=$("<option><\/option>").val(t.Name).text(t.Name+" : "+t.Description);t.Name===this.selected&&i.attr("selected","selected");this.ddl.append(i)}.bind({ddl:this.ddl,selected:i.getResponseHeader("Selected")}))}.bind({ddl:t}),function(n,t){var i=$("<option><\/option>").val("").html('<span class="bg-danger">Could not retrieve printer list: '+t+" "+n.status+"<\/span>");this.append(i)}.bind(this))}function OnPrint(n){function t(n,t){$("div.alert",this).removeClass().addClass("alert").addClass(t).html(n)}var i=$(n.delegateTarget),r=$("select",i).val();if(!r){t.call(i,"Please Select a printer","alert-warning");return}n.data.postdata[0].value=$("span.cartonId",i).text();n.data.postdata[1].value=r;$.post(n.data.url,n.data.postdata).then(function(n,i,r){t.call(this.dlg,r.responseText,r.status===203?"alert-warning":"alert-success")}.bind({dlg:n.delegateTarget}),function(n){Sound.error();t.call(this.dlg,n.responseText,"alert-danger")}.bind({dlg:n.delegateTarget}))}function OnRemove(n){var t=$(n.delegateTarget);n.data.postdata[0].value=$("span.cartonId",t).text();$.post(n.data.url,n.data.postdata).then(function(n){t.modal("hide");Tabs.html(n);Progress.update(-1)}.bind({dlg:n.delegateTarget}),function(n){Sound.error();alert("Error: "+n.responseText)}.bind({dlg:n.delegateTarget}))}var Sound=function(){"use strict";var n={error:null,success:null},t=function(t){n=$.extend(n,t)},i=function(){$(n.error).one("ended",function(){this.play()})[0].play()},r=function(){$(n.success)[0].play()};return{init:t,error:i,success:r}}(),Progress=function(){"use strict";var n={bar:"#progressCartons",receivedCount:"#receivedCount"},t=function(t){n=$.extend(n,t)},i=function(t){var i=$(n.bar+"div.progress-bar"),r=parseInt(i.attr("aria-valuenow"))+t,e=parseInt(i.attr("aria-valuemax")),u=Math.round(r*100/e),f;i.attr("aria-valuenow",r).css("width",u+"%").find("span").text(u);f=parseInt($(n.receivedCount).text());$(n.receivedCount).text(f+t)};return{init:t,update:i}}(),Tabs=function(){"use strict";var n={tabContainer:"",contentContainer:"",loadUrl:"",pallets:[]},t="data-palletid",u=function(t){n=$.extend(n,t);var i;$.each(n.pallets,function(n,t){var r=Tabs.create(t);n===0&&(i=r)});$(n.tabContainer).on("click",".glyphicon-remove-sign",function(n){var t=$(this).closest("li"),i,r;t.is(".active")&&(i=t.next(),i.length===0&&(i=$("li:first",n.delegateTarget)),$("a",i).tab("show"));r=$("a",t).attr("href");$(r).remove();t.remove()}).on("shown.bs.tab",function(){r()}).find("li:first a").tab("show")},i=function(){return $("> div.active.tab-pane",n.contentContainer)},f=function(){return $("> li.active",n.tabContainer).attr(t)},e=function(i){var u="Pallet_"+(i||"NOPALLET"),r;return $("<div><\/div>").attr("id",u).addClass("tab-pane").appendTo(n.contentContainer),r=$("<a><\/a>").attr({href:"#"+u,role:"tab","data-toggle":"tab",title:"Pallet "+(i||"??")}).text(i||"NOPALLET"),i&&r.append(' <span title="Remove Pallet" class="glyphicon glyphicon-remove-sign text-info"><\/span>'),$("<li><\/li>").attr(t,i).append(r).appendTo(n.tabContainer)},o=function(i){var r=$("> li["+t+'="'+i+'"] > a',n.tabContainer).tab("show");r.length>0||Tabs.create(i).find("a").tab("show")},s=function(n){i().html(n)},r=function(){return Tabs.html("Loading..."),$.get(n.loadUrl.replace("~",Tabs.activePalletId())).then(function(n){Tabs.html(n)},function(n){Tabs.html(n.responseText)})};return{init:u,create:e,activePalletId:f,html:s,show:o,activeContent:i,load:r}}(),HandleScan=function(){"use strict";var t,i,n={textarea:"",button:"",cartonUrl:$("#tbScan").data("carton-url"),cartonPostdata:function(n,t){return[{name:"processId",value:123},{name:"cartons",value:t},{name:"palletId",value:n},{name:"dispos",value:"something"}]},delay:3e3},r=function(){return t?(clearInterval(t),t=null,$("span.badge",n.button).addClass("hidden"),!0):!1},h=function(){r();i=n.delay;$("span.badge",n.button).removeClass("hidden").text("");t=setInterval(function(){i-=1e3;$("span.badge",n.button).text(i/1e3);i<=0&&o()},1e3)},c=function(){r();$(n.button).prop("disabled",!0).find("img").removeClass("hidden");$(n.textarea).prop("disabled",!0);a()},l=function(){$(n.button).prop("disabled",!1).find("img").addClass("hidden");$(n.textarea).prop("disabled",!1)},u=function(t){Sound.error();$(n.textarea).attr("data-content",t).popover("show");$(n.button).next("button").removeClass("hidden")},a=function(){$(n.button).next("button").addClass("hidden");$(n.textarea).popover("hide")},v=function(t){n=$.extend(n,t);$(n.textarea).on("keypress",function(n){if(r(),n.which===13){var t=f();if(t.length!==0){if(!Tabs.activePalletId()&&!e(t[t.length-1])){u("Please scan a pallet first");setTimeout(function(n){n.focus();n.select()}.bind(undefined,n.target),0);return}Sound.success();h()}}}).popover({trigger:"manual",html:!0,title:'<strong class="text-danger"><span class="text-danger glyphicon glyphicon-warning-sign"><\/span> Error Message<\/strong><a class="close text-danger" href="#">&times;<\/a>',placement:"auto",container:"body"});$(document).on("click",".close",function(){$(n.textarea).popover("hide").focus()});$(n.button).on("click",o).next("button").on("click",function(){$(n.textarea).popover("show")})},f=function(){return $.grep($(n.textarea).val().toUpperCase().split("\n"),function(n){return n.trim().toUpperCase()!==""})},e=function(n){return n.toUpperCase().indexOf("P")===0},o=function(){var t;if(r(),t=f(),t.length!==0){var u=$.Deferred(c),i=u,o=t[t.length-1];e()?(t.length>1&&(i=i.then(s.bind(undefined,t.slice(0,t.length-1)))),i=i.then(y.bind(undefined,o))):i=i.then(s.bind(undefined,t));$(n.textarea).val("");i=i.always(l).always(function(){$(n.textarea).focus()});u.resolve()}},s=function(t){return $.post(n.cartonUrl,n.cartonPostdata(Tabs.activePalletId(),t)).then(function(t){if(t&&t.length>0){var i=$('<ul class="list-group"><\/ul>'),r=[];$.each(t,function(n,t){$('<li class="list-group-item list-group-item-warning"><\/li>').text(t.cartonId+": "+t.message).appendTo(i);r.push(t.cartonId)});u(i[0].outerHTML);$(n.textarea).val(r.join("\n"))}else $(n.textarea).val();Tabs.load();Progress.update(this.count)}.bind({count:t.length}),function(n,t,i){switch(n.status){case 500:u(n.responseText);break;default:u("Error "+n.status+": "+i)}})},y=function(n){Tabs.show(n)};return{init:v}}();