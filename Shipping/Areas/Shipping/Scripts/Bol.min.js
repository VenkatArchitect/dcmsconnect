$(function(){$.widget("ui.selectable",$.ui.selectable,{_mouseStart:function(a){a.ctrlKey=true;this._super(a)},_mouseDrag:function(a){a.ctrlKey=true;this._super(a)},_mouseStop:function(a){a.ctrlKey=true;this._super(a)},_trigger:function(b,a,c){if(b=="selecting"){$(c.selecting).addClass("ui-selected")}this._super(b,a,c)}})});function AppointmentSimilar(a,b){if(a.id&&b.id){return a.id==b.id}return a.CarrierId&&b.CarrierId&&a.start&&b.start&&a.CarrierId==b.CarrierId&&Number(a.start)==Number(b.start)}$(function(){$.widget("bol.calendar",{options:{initialAppointment:null,click:null,change:null},_loader:null,_create:function(){var a;if(this.options.initialAppointment&&this.options.initialAppointment.start){a=$.fullCalendar.parseDate(this.options.initialAppointment.start)}var b=this;this.element.fullCalendar({theme:true,weekends:true,height:350,header:{left:"prev,next today",center:"title",right:""},defaultView:"basicWeek",timeFormat:"h:mm TT",allDayDefault:false,ignoreTimezone:false,year:a?a.getFullYear():undefined,month:a?a.getMonth():undefined,date:a?a.getDate():undefined,events:function(e,d,c){b._load(e,d,c)},eventClick:function(c,d,e){if($(d.target).is(".new-event")){b._createAppointment(c);return}if(c){if(c.id){b.selectAppointment(c);b._trigger("click",d,{app:c});return}if(confirm("This appointment has not yet been created. Would you like to create it now?")){b._createAppointment(c)}}},eventRender:function(d,c,e){c.attr("title",d.EventToolTip);if(d.appointmentHtml){$(".fc-event-inner",c).append(d.appointmentHtml)}$(".fc-event-title",c).attr("title",d.AppointmentDateDispaly)}})},_load:function(d,c,a){var b=new Object();b[this.element.attr("data-start-param")]=Math.round(+d/1000);b[this.element.attr("data-end-param")]=Math.round(+c/1000);this._loader=$.ajax({url:this.element.attr("data-event-source"),dataType:"json",data:b,traditional:true,cache:false,context:this,success:function(f,h,g){if(this.options.initialAppointment&&this.options.initialAppointment.id){var e=$.each(f,function(j,k){if(k.id==_initialAppointment.id){k.className="ui-selected"}})}a(f)},error:function(f,g,e){alert(f.responseText);a([])},})},selectAppointment:function(a){if(a.start){this.element.fullCalendar("gotoDate",a.start)}var b=this;this._loader.done(function(){b._doSelectAppointment(a);b._trigger("change",null,{app:a})})},_doSelectAppointment:function(a){var b=this.element.fullCalendar("clientEvents",function(c){if(AppointmentSimilar(a,c)){c.className="ui-selected";return true}else{c.className="";return false}});if(b.length>0){this.element.fullCalendar("rerenderEvents")}else{a.title="New Appointment for Building "+a.BuildingId+", Carrier "+a.CarrierId+".";a.className="ui-state-highlight";a.appointmentHtml='<a href="#" class="new-event">Create</a>';this.element.fullCalendar("renderEvent",a)}},_createAppointment:function(a){$.ajax({url:this.element.attr("data-create-url"),type:"POST",data:{start:Number(+a.start/1000),CarrierId:a.CarrierId,BuildingId:a.BuildingId},context:this,success:function(b,e,c){if(c.status==203){alert(b);return}this.element.fullCalendar("refetchEvents");var d=this;this._loader.done(function(){if($.type(b.start)=="string"){b.start=$.fullCalendar.parseDate(b.start)}d.selectAppointment(b)})},error:function(c,d,b){alert(c.responseText)}})},rerenderEvents:function(){this.element.fullCalendar("rerenderEvents")},selectedAppointment:function(){var a=this.element.fullCalendar("clientEvents",function(b){if(b.className=="ui-selected"){return true}});if(a.length==0){return null}return a[0]}})});$(function(){$.widget("ui.selectable",$.ui.selectable,{options:{dialog:null,appointment:null,matched:null,filter:"tr:not(.ui-state-disabled)",cancel:"a,td:has(.ui-icon-close),td:has(.ui-icon-trash),td:has(.ui-icon-calendar),tr.ui-state-disabled"},_dlg:null,_appointment:null,_create:function(){this._super();var a=this;this._dlg=$("#popup");this._on(this._dlg,{click:"_synchronize"})},_trigger:function(f,e,d){switch(f){case"stop":var b=$("tr",this.element);b.removeClass("ui-state-highlight");var a=b.filter(".ui-selected");var c;if(a.length==1){c=this.options.appointment(a)}this.refreshPopup(c,e);break}this._super(f,e,d)},_synchronize:function(a){if($(a.target).is(".ui-icon-close")){this._dlg.hide("explode");return}if(!$(a.target).is("a")){return}if(!this._appointment){alert("Should never happen");return}var b=this;$(this.options.filter,this.element).filter(function(){return AppointmentSimilar(b.options.appointment($(this)),b._appointment)}).addClass("ui-selected");this._trigger("matched",a,{app:b._appointment})},refreshPopup:function(a,c){var b;if(a){var d=this;b=$(this.options.filter,this.element).filter(function(){return AppointmentSimilar(d.options.appointment($(this)),a)}).length}else{b=0}if(b>0){this._dlg.show().find("span:first").html(b+" matching BOL").end().find("[data-for=title]").text(a.title).end().position({my:"left bottom",at:"left top",of:c}).effect("slide",{},500);this._appointment=a}else{this._dlg.hide();this._appointment=null}}})});$(document).ready(function(){$("#calendar").calendar({initialAppointment:_initialAppointment,click:function(b,c){$("#tbody").selectable("refreshPopup",c.app,b.originalEvent)}});function a(){if(!$("#dlgCalendar").dialog("isOpen")){return}var c=$("#tbody tr.ui-selected");var d=$("#calendar").calendar("selectedAppointment")!=null&&c.length>0;var b=$("#btnApply").prop("disabled",!d).toggleClass("ui-state-disabled",!d);if(d){$("span.ui-button-text",b).text("Assign "+c.length+" BOL")}else{$("span.ui-button-text",b).text("Assign BOL")}}$("#dlgCalendar").dialog({title:"Pick Appointment",autoOpen:_initialAppointment?true:false,width:600,height:450,modal:false,cache:false,closeOnEscape:true,dialogClass:"dlg-appointment",position:{my:"right center",at:"right top"},create:function(b,d){var c=this;$("#tbody").bind("selectablestop",function(e,f){a()});$("#calendar").bind("calendarchange",function(e,f){a()})},open:function(b,c){$("#calendar").calendar("rerenderEvents");a()},buttons:[{text:"Assign BOL",id:"btnApply",click:function(e,f){var b=$("#frmBol");var d=$("#calendar").calendar("selectedAppointment");if(!d){alert("No Appointment selected");return}$("#hfAppointmentId").val(d.id);$("#hfAssignFlag").val("true");var c=$("#tbody tr.ui-selected input:checkbox").clone().prop("checked",true).appendTo(b);if(c.length==0){alert("Please select some BOLs");return}$(this).dialog("close");b.submit()}},{text:"Cancel",click:function(b,c){$("#dlgCalendar").dialog("close")}}]});$("#tbody").on("click","a.ui-icon-close",function(b){$(this).parents("tr").addClass("ui-selected ui-selectee");var c=$("#tbody tr.ui-selected").map(function(){return $(this).attr("data-shippingid")}).get();if(!confirm("Do you want to delete "+c.length+" BOLs")){return false}var d=$(this).attr("data-url-delete");d=d.replace("X",c.join(","));$.ajax({cache:false,url:d,type:"POST",context:this,success:function(e,g,f){if(f.status==203){$("#divAjaxError").html(e).addClass("ui-state-highlight");return false}$("#tbody").find("tr.ui-selected").addClass("text-changed ui-state-disabled").removeClass("ui-selected ui-selectee").find("a").removeClass("ui-icon ui-icon-close ui-icon-calendar").text("Done");a();$("#divAjaxError").html(e).addClass("ui-state-highlight")},error:function(f,g,e){alert(f.responseText)}});return false}).selectable({appointment:function(b){var c=_appointments[b.attr("data-shippingid")];c.start=$.fullCalendar.parseDate(c.start);return c},dialog:"#automatch",calendar:"#calendar",matched:function(b,c){$("#dlgCalendar").dialog("option","position",{my:"left-bottom",at:"rigth",of:window}).dialog("open");$("#calendar").calendar("selectAppointment",c.app)}});$("table thead input:checkbox").click(function(d){var b=$("tbody tr.ui-selectee",$(this).closest("table"));b.removeClass("ui-state-highlight");var c=$(this).is(":checked");b.toggleClass("ui-selected",c);$("#tbody").trigger("selectablestop")});$("#btnAppointments").click(function(b){$("#dlgCalendar").dialog("open")}).button();$("#cbShowScheduled").change(function(b){$("#frmShowScheduled").submit()});$("#tbody").on("click","a.ui-icon-calendar",function(g){var d=$(g.target).closest("tr").addClass("ui-selected ui-selectee");var f=$("#tbody tr.ui-selected input:checkbox").clone().prop("checked",true);if(!confirm("Do you want to unassign appointment from "+f.length+"BOL")){return false}var b=$("#frmBol");$("#hfAssignFlag").val("false");var c=f.appendTo(b);if(c.length==0){alert("Please select some BOLs");return}b.submit()})});